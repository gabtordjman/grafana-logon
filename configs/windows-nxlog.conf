## NXLog Configuration - using GELF to send the logs to Alloy
## The IP address needs to be defined manually in the processor "add_ip"
define ROOT C:\Program Files\nxlog

Moduledir %ROOT%\modules
CacheDir   %ROOT%\data
Pidfile    %ROOT%\data\nxlog.pid
SpoolDir   %ROOT%\data
LogFile    %ROOT%\data\nxlog.log
LogLevel   INFO

# Get logs events from Security tab
<Input in_security>
    Module      im_msvistalog
    <QueryXML>
        <QueryList>
            <Query Id='0'>
                <Select Path='Security'>*</Select>
            </Query>
        </QueryList>
    </QueryXML>
</Input>

# Get RDP Events (Event ID 25)
<Input in_rdp>
    Module      im_msvistalog
    <QueryXML>
        <QueryList>
            <Query Id='1'>
                <Select Path='Microsoft-Windows-TerminalServices-LocalSessionManager/Operational'>
                    *[System[(EventID=25)]]
                </Select>
            </Query>
        </QueryList>
    </QueryXML>
</Input>

# Get Application Errors
<Input in_app_errors>
    Module      im_msvistalog
    <QueryXML>
        <QueryList>
            <Query Id='2'>
                <Select Path='Application'>
                    *[System[(Level=2)]]
                </Select>
            </Query>
        </QueryList>
    </QueryXML>
</Input>

# Get System Errors
<Input in_system_errors>
    Module      im_msvistalog
    <QueryXML>
        <QueryList>
            <Query Id='3'>
                <Select Path='System'>
                    *[System[(Level=2)]]
                </Select>
            </Query>
        </QueryList>
    </QueryXML>
</Input>

# Processor to add static IP field to all events
<Processor add_ip>
    Module      pm_transformer
    Exec        $ip_address = "192.168.1.206"; # Change IP if needed to be the same as your machine
</Processor>

# Set Graylog server - using Alloy but it supports GELF
<Extension gelf>
    Module        xm_gelf
</Extension>

<Output graylog_udp>
    Module        om_udp
    Host          192.168.1.207
    Port          12201
    OutputType    GELF_UDP
</Output>

# Routing to Alloy with enrichment
<Route 1>
    Path        in_security, in_rdp, in_app_errors, in_system_errors => add_ip => graylog_udp
</Route>
